<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rubix Chat</title>
    <style>
      :root { --bg:#0b0f17; --panel:#0b1220; --text:#e5e7eb; --muted:#94a3b8; --line:#1f2937; --pink:#e6007a; --dockH: 150px; --heroGap: 6px; --heroMin: 36vh; --pageMax: 1100px; }
      html, body { height:100%; margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); color:var(--text); overflow-y:auto; overflow-x:hidden; }
      .shell { min-height:100vh; position:relative; overflow-x:hidden; padding-bottom: 0; padding-top: 56px; }
      /* Ambient background */
      .shell::before { content:""; position:absolute; width:900px; height:900px; left:50%; top:-300px; transform: translateX(-50%); border-radius:50%; background: radial-gradient(closest-side, rgba(230,0,122,0.22), transparent 70%); filter: blur(60px); pointer-events:none; }
      .shell::after { content:""; position:absolute; width:720px; height:720px; right:-220px; bottom:-220px; border-radius:50%; background: radial-gradient(closest-side, rgba(34,211,238,0.16), transparent 70%); filter: blur(50px); pointer-events:none; }

      .hero-wrap { display:grid; place-items:center; gap: var(--heroGap); min-height: var(--heroMin); max-width: var(--pageMax); margin: 16px auto 8px auto; padding: 0 18px; text-align:center; transition: min-height .35s ease, padding .35s ease, margin .35s ease; }
      .brand { isolation: isolate; }
      .brand img { width: clamp(160px, 20vw, 300px); height:auto; object-fit: contain; border: none; border-radius: 0; mix-blend-mode: normal; filter: drop-shadow(0 8px 22px rgba(230,0,122,0.35)); }
      .hero h1 { margin: 0; font-size: clamp(18px, 2.2vw, 20px); font-weight: 700; }

      /* Chatting mode */
      .shell.chatting .hero-wrap { min-height: 80px; padding-top: 0; margin: 12px auto; }
      .shell.chatting .brand { position: sticky; top: 48px; z-index: 9998; }
      .shell.chatting .brand img { width: 180px; }
      .shell.chatting .hero h1 { display:none; }

      /* Chat container */
      .chat-container { max-width: 980px; margin: 18px auto; padding: 0; border-radius:20px; border:1px solid rgba(255,255,255,0.08); background: rgba(11,18,32,0.85); backdrop-filter: blur(6px); box-shadow: 0 26px 60px rgba(0,0,0,0.45), 0 0 0 1px rgba(255,255,255,0.02) inset; overflow:hidden; }
      .chat-container::before { content:""; display:block; height:6px; background: linear-gradient(90deg, #e6007a, #22d3ee); filter: blur(0.2px); opacity:0.7; }
      .chat-header { position: sticky; top: 0; z-index: 2; background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0)); padding: 10px 18px; display:flex; align-items:center; justify-content:space-between; }
      .chat-title { font-weight:800; letter-spacing:.2px; color:#e5e7eb; }
      .model-name { font-weight:400; color: var(--muted); margin-left:8px; }
      .chat-hint { font-size:12px; color:#94a3b8; }

      /* Messages area (optional, appears as you chat) */
      .hidden { display:none; }
      #chat { max-width: 900px; margin: 10px auto; padding: 0 18px 12px; display:flex; flex-direction:column; gap:10px; transition: margin .35s ease; }
      .shell.chatting { padding-bottom: 0; }
      .shell.chatting #chat { margin: 18px auto 0 auto; }
      .msg { padding:14px 16px; border-radius:16px; max-width: 70%; white-space: pre-wrap; box-shadow: 0 6px 18px rgba(0,0,0,0.25); border:1px solid rgba(255,255,255,0.06); animation: fadeInUp .25s ease both; position: relative; }
      @keyframes fadeInUp { from { opacity:0; transform: translateY(6px) } to { opacity:1; transform: translateY(0) } }
      .me { align-self:flex-end; background:#121a2a; color:var(--text); border:1px solid rgba(255,255,255,0.08); box-shadow: 0 6px 18px rgba(0,0,0,0.28); }
      .bot { align-self:flex-start; background:#0e1422; color:var(--text); border:1px solid #1f2a3a; box-shadow: 0 6px 18px rgba(0,0,0,0.26); }

      /* Typing indicator */
      .typing { align-self:flex-start; background:#0e1422; color:var(--text); border:1px solid #1f2a3a; box-shadow: 0 6px 18px rgba(0,0,0,0.26); position:relative; }
      .typing::after { content:""; position:absolute; left:-8px; bottom:10px; width:10px; height:10px; background:#0e1422; border:1px solid #1f2a3a; border-radius:50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
      .typing .dots { display:inline-block; width:30px; text-align:left; }
      .typing .dots i { display:inline-block; width:6px; height:6px; margin-right:4px; background:#cbd5e1; border-radius:50%; opacity:.6; animation: blink 1s infinite; }
      .typing .dots i:nth-child(2){ animation-delay:.15s }
      .typing .dots i:nth-child(3){ animation-delay:.3s }
      @keyframes blink { 0%, 80%, 100% { opacity:.2 } 40% { opacity:1 } }

      /* Bottom input dock (sticky inside container) */
      .dock-wrap { position: sticky; bottom: 12px; }
      .dock { max-width: 900px; margin: 0 auto; padding: 0 18px; }
      .dock-inner { background:#0b1220; border:1px solid var(--line); border-radius: 18px; padding: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
      .row { display:flex; gap:10px; align-items:center; }
      .row input { flex:1; background:#0b1220; border:1px solid var(--line); color:var(--text); border-radius: 14px; padding:14px 16px; outline:none; }
      .send { display:flex; align-items:center; gap:8px; background: var(--pink); border:0; color:#fff; border-radius: 12px; padding: 12px 16px; cursor:pointer; font-weight:800; position:relative; overflow:hidden; }
      .send.loading { opacity:.9; pointer-events:none; }
      /* disable spinner on send button */
      .send.loading::after { content: none; border: 0; }
      @keyframes spin { to { transform: rotate(360deg) } }
      .ripple { position:absolute; border-radius:50%; background: rgba(255,255,255,0.35); transform: scale(0); animation: ripple .6s ease-out forwards; pointer-events:none; }
      @keyframes ripple { to { transform: scale(6); opacity:0 } }
      .send svg { width: 18px; height:18px; }
      .disclaimer { margin: 8px 2px 0 2px; font-size:12px; color: var(--muted); }

      /* Tools (copy/clear) */
      .tools { display:flex; justify-content:flex-end; gap:10px; margin: 6px 0 0 0; }
      .tool { background:#0b1220; border:1px solid var(--line); color:#cbd5e1; border-radius:10px; padding:6px 10px; font-size:12px; cursor:pointer; }
      .tool:hover { border-color:#334155; }

      /* Opening suggestion cards */
      .suggest { display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:18px; max-width: var(--pageMax); margin: 16px auto 0 auto; padding: 0 18px; }
      .s-card { display:flex; flex-direction:column; align-items:center; text-align:center; color:var(--text); cursor:pointer; border-radius:18px; padding:24px; border:1px solid #1f2937; background: rgba(255,255,255,0.03); box-shadow: 0 8px 24px rgba(0,0,0,0.25); transition: transform .18s ease, box-shadow .18s ease, background .18s ease; }
      .s-card:hover { transform: translateY(-3px); box-shadow: 0 12px 32px rgba(0,0,0,0.35); background: rgba(255,255,255,0.04); }
      .s-icon { width:48px; height:48px; display:grid; place-items:center; border-radius:50%; color:#0b0f17; font-size:22px; margin-bottom:10px; box-shadow: 0 6px 16px rgba(0,0,0,0.25), inset 0 1px 0 rgba(255,255,255,0.5); }
      .s-card:nth-child(1) .s-icon { background: linear-gradient(135deg, #ff4db2, #e6007a); color:#fff; }
      .s-card:nth-child(2) .s-icon { background: linear-gradient(135deg, #22d3ee, #06b6d4); color:#002027; }
      .s-card:nth-child(3) .s-icon { background: linear-gradient(135deg, #a78bfa, #60a5fa); color:#0b0f17; }
      .s-title { font-weight:800; margin:6px 0 6px 0; font-size:17px; }
      .s-sub { margin:0; color: var(--muted); font-size:12.5px; }
      .shell.chatting .suggest { display:none; }

      /* Logout button - pill, gradient, hover + ripple */
      .topbar { position: fixed; top: 8px; left: 16px; right: auto; z-index: 9999; margin: 0; padding: 0; display:flex; justify-content:flex-start; }
      .logout { display:flex; align-items:center; gap:8px; background: linear-gradient(90deg, #e6007a, #ff4db2); color:#fff; border:0; border-radius:999px; padding:10px 14px; cursor:pointer; box-shadow: 0 8px 24px rgba(230,0,122,0.25); transition: transform .12s ease, box-shadow .12s ease, opacity .2s ease; overflow:hidden; }
      .logout:hover { transform: translateY(-1px); box-shadow: 0 10px 28px rgba(230,0,122,0.32); }
      .logout:active { transform: translateY(0); }
      .logout:focus-visible { outline: none; box-shadow: 0 0 0 3px rgba(255,255,255,0.2), 0 8px 24px rgba(230,0,122,0.28); }
      .logout .ico { width:16px; height:16px; }

      /* Meta line under bot messages */
      .meta-line { margin-top: 6px; font-size: 12px; line-height: 1.4; color: var(--muted); display:flex; align-items:center; gap:6px; flex-wrap:wrap; }
      .meta-text { color: var(--muted); font-weight: 500; }
      /* Citations */
      .citations { display:flex; gap:6px; flex-wrap:wrap; }
      .cite { background:#0b1220; border:1px solid #1f2937; color:#cbd5e1; border-radius:12px; padding:3px 8px; font-size:12px; line-height:1.2; box-shadow: 0 1px 4px rgba(0,0,0,0.2); }
      .cite:hover { border-color:#334155; }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="topbar">
        <button class="logout" id="logoutBtn" title="Logout">
          <svg class="ico" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 16l5-4-5-4M19 12H9" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19H7a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h5" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span>Logout</span>
        </button>
      </div>
      <div class="hero-wrap">
        <div class="brand">
          <img id="brandLogo" src="/rubix_logo.png" alt="Rubix Logo" />
        </div>
        <div class="hero">
          <h1>Welcome to Rubix Chat System. How can I help you today?</h1>
        </div>
      </div>

      <div class="chat-container">
        <div class="chat-header">
          <div class="chat-title">Chat <span class="model-name">· Llama 3.2 3B</span></div>
          <div class="chat-hint">Policy Q&A · HR and IT</div>
        </div>
        <div id="chat" class="hidden"></div>
        <div class="dock-wrap">
          <div class="dock">
            <div class="dock-inner">
              <div class="row">
                <input id="question" placeholder="Ask anything" />
                <button class="send" id="sendBtn">
                  <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 12L3 4l18 8-18 8 2-8zm0 0l13-0" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                  <span>Send</span>
                </button>
              </div>
              <div class="disclaimer">AI may generate inaccurate information. Verify important answers.</div>
            </div>
          </div>
        </div>
      </div>
      <div class="suggest" id="suggest">
        <div class="s-card" data-q="How many annual leave days can I carry over?">
          <div class="s-icon">🏖️</div>
          <p class="s-title">How many annual leave days can I carry over?</p>
          <p class="s-sub">Carryover eligibility and when to use remaining days.</p>
        </div>
        <div class="s-card" data-q="What are the password rules (length, complexity, rotation)?">
          <div class="s-icon">🔐</div>
          <p class="s-title">What are the password rules?</p>
          <p class="s-sub">Length, complexity, and rotation requirements.</p>
        </div>
        <div class="s-card" data-q="What is the device policy for company laptops and BYOD?">
          <div class="s-icon">💻</div>
          <p class="s-title">What is the device policy for laptops/BYOD?</p>
          <p class="s-sub">Usage, security settings, and responsibilities.</p>
        </div>
      </div>

    </div>

    <script>
      const apiBase = location.origin + '/api/v1';
      const shell = document.querySelector('.shell');
      const chatEl = document.getElementById('chat');
      const qEl = document.getElementById('question');
      const sendBtn = document.getElementById('sendBtn');
      const statusEl = { textContent: '' };
      const brandLogo = document.getElementById('brandLogo');
      const logoutBtn = document.getElementById('logoutBtn');
      // fallback if png missing
      brandLogo.addEventListener('error', () => { brandLogo.src = '/rubix_logo.jpg'; });

      function ensureChatMode(){
        if (!shell.classList.contains('chatting')) {
          shell.classList.add('chatting');
          if (!chatEl.textContent.trim()) {
            addMsg('Welcome to Rubix Chat System. How can I help you today?', 'bot');
          }
          const s = document.getElementById('suggest');
          if (s) s.style.display = 'none';
        }
      }

      function token(){ return localStorage.getItem('token') || ''; }
      function requireAuth(){ if (!token()) location.href='/login.html'; }
      function logout(){ localStorage.removeItem('token'); location.href='/login.html'; }
      function addMsg(text, who){
        if (chatEl.classList.contains('hidden')) chatEl.classList.remove('hidden');
        const d=document.createElement('div'); d.className='msg '+who; d.textContent=text; chatEl.appendChild(d);
        // ensure newest message is visible even with fixed dock
        requestAnimationFrame(()=>{
          const y = document.documentElement.scrollHeight;
          window.scrollTo({ top: y, behavior: 'smooth' });
        });
      }

      // Typewriter render for bot answers (returns a Promise resolved when complete)
      function typeBotMessage(text){
        return new Promise((resolve) => {
          if (chatEl.classList.contains('hidden')) chatEl.classList.remove('hidden');
          const bubble = document.createElement('div');
          bubble.className = 'msg bot';
          bubble.textContent = '';
          chatEl.appendChild(bubble);

          let i = 0;
          const writeNext = () => {
            if (i >= text.length) { resolve(); return; }
            bubble.textContent += text[i];
            i += 1;
            // keep newest content visible
            if ((i & 3) === 0) {
              const y = document.documentElement.scrollHeight;
              window.scrollTo({ top: y, behavior: 'smooth' });
            }
            const ch = text[i-1];
            const delay = ',.;!?'.includes(ch) ? 45 : 14;
            setTimeout(writeNext, delay);
          };
          writeNext();
        });
      }

      async function send(){
        const q = qEl.value.trim();
        if(!q) return;
        ensureChatMode();
        addMsg(q, 'me');
        qEl.value='';
        // button ripple + loading
        sendBtn.classList.add('loading');
        // persistent typing indicator until answer arrives
        const t = document.createElement('div'); t.className = 'msg typing'; t.innerHTML = '<span class="dots"><i></i><i></i><i></i></span>';
        chatEl.appendChild(t);
        requestAnimationFrame(()=>{
          const y = document.documentElement.scrollHeight;
          window.scrollTo({ top: y, behavior: 'smooth' });
        });
        try{
          const res = await fetch(`${apiBase}/chat/`, { method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': `Bearer ${token()}` }, body: JSON.stringify({ question: q })});
          if(!res.ok) throw new Error(await res.text());
          const data = await res.json();
          const ans = data.answer || (data.needs_clarification ? data.clarification : 'No answer');
          t.remove();
          // show answer progressively, then append meta after completion
          await typeBotMessage(ans);
          const meta = document.createElement('div');
          meta.className = 'meta-line';
          const metaText = document.createElement('span');
          metaText.className = 'meta-text';
          const conf = (typeof data.confidence === 'number') ? ` · confidence ${Math.round(data.confidence * 100)}%` : '';
          const counts = ''; // do not display token/char counts on UI per request
          let citationStr = '';
          if (Array.isArray(data.citations) && data.citations.length) {
            const first = data.citations[0];
            const src = first.source || (data.domain || 'Policy');
            const head = first.heading ? ` — ${first.heading}` : '';
            citationStr = ` · citation ${src}${head}`;
          }
          metaText.textContent = `domain ${data.domain || 'N/A'}${conf}${counts}${citationStr}`;
          meta.appendChild(metaText);
          chatEl.appendChild(meta);
          requestAnimationFrame(()=>{ const y=document.documentElement.scrollHeight; window.scrollTo({ top:y, behavior:'smooth' }); });
          statusEl.textContent = `Latency: ${data.latency_ms} ms`;
        }catch(e){ t.remove(); addMsg('Error from server', 'bot'); }
        finally { sendBtn.classList.remove('loading'); }
      }

      sendBtn.addEventListener('click', send);
      qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); send(); } });
      document.querySelectorAll('.s-card').forEach(c=> c.addEventListener('click', ()=>{ qEl.value = c.dataset.q; send(); }));
      logoutBtn.addEventListener('click', logout);
      // Guard
      requireAuth();
      statusEl.textContent = 'Ready';
      // Ensure fresh view on load
      chatEl.innerHTML = '';
      chatEl.classList.add('hidden');
    </script>
  </body>
  </html>

